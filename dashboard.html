import { getAuth, onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

import { initializeApp, getApps } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

/* ---------------- USE EXISTING APP ---------------- */
const app = getApps()[0]; // üî• reuse already initialized app
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

console.log("‚úÖ vaccine.js loaded and using existing Firebase app");

const el = id => document.getElementById(id);

/* ---------------- AUTH ---------------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  const vacRef = doc(db, "farmers", user.uid, "meta", "vaccines");
  const snap = await getDoc(vacRef);

  if (snap.exists()) {
    const d = snap.data();
    showPreview("v1Preview", d.v1);
    showPreview("v2Preview", d.v2);
    showPreview("v3Preview", d.v3);
  }

  el("saveVaccine").onclick = () => saveVaccines(user.uid);
});

/* ---------------- SAVE ---------------- */
async function saveVaccines(uid) {
  try {
    const data = {};

    if (file("v1Img")) data.v1 = await upload(uid, "v1", file("v1Img"));
    if (file("v2Img")) data.v2 = await upload(uid, "v2", file("v2Img"));
    if (file("v3Img")) data.v3 = await upload(uid, "v3", file("v3Img"));

    if (Object.keys(data).length === 0) {
      alert("Please select at least one vaccine image");
      return;
    }

    await setDoc(
      doc(db, "farmers", uid, "meta", "vaccines"),
      data,
      { merge: true }
    );

    Object.entries(data).forEach(([k, v]) =>
      showPreview(`${k}Preview`, v)
    );

    alert("‚úÖ Vaccination details saved successfully");

  } catch (e) {
    console.error(e);
    alert("‚ùå Error saving vaccination details");
  }
}

/* ---------------- HELPERS ---------------- */
function file(id) {
  return el(id)?.files?.[0];
}

async function upload(uid, key, file) {
  const storageRef = ref(storage, `vaccines/${uid}/${key}.jpg`);
  await uploadBytes(storageRef, file);
  return await getDownloadURL(storageRef);
}

function showPreview(id, url) {
  if (!url) return;
  const img = el(id);
  if (img) img.src = url;
}
