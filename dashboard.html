import { getAuth, onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
import { getApps, initializeApp } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

/* üî• reuse existing app */
const app = getApps().length ? getApps()[0] : initializeApp({});
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const el = id => document.getElementById(id);

onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  const refDoc = doc(db, "farmers", user.uid, "meta", "vaccines");
  const snap = await getDoc(refDoc);

  if (snap.exists()) {
    const d = snap.data();
    preview("v1Preview", d.v1);
    preview("v2Preview", d.v2);
    preview("v3Preview", d.v3);
  }

  el("saveVaccine").onclick = async () => {
    try {
      const data = {};

      if (el("v1Img").files[0])
        data.v1 = await upload(user.uid, "v1", el("v1Img").files[0]);
      if (el("v2Img").files[0])
        data.v2 = await upload(user.uid, "v2", el("v2Img").files[0]);
      if (el("v3Img").files[0])
        data.v3 = await upload(user.uid, "v3", el("v3Img").files[0]);

      if (!Object.keys(data).length) {
        alert("Please select at least one vaccine image");
        return;
      }

      await setDoc(refDoc, data, { merge: true });

      Object.entries(data).forEach(([k, v]) =>
        preview(`${k}Preview`, v)
      );

      alert("‚úÖ Vaccination details saved successfully");

    } catch (e) {
      console.error(e);
      alert("‚ùå Error saving vaccination details");
    }
  };
});

async function upload(uid, key, file) {
  const storageRef = ref(storage, `vaccines/${uid}/${key}.jpg`);
  await uploadBytes(storageRef, file);
  return await getDownloadURL(storageRef);
}

function preview(id, url) {
  if (url && el(id)) el(id).src = url;
}
